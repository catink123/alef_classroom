{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ classroom.name }} - Alef Classroom{% endblock %}

{% block content %}
<div class="classroom-detail">
    <!-- Classroom Header -->
    <div class="classroom-header">
        <div class="classroom-banner">
            {% if classroom.banner_image %}
                <img src="{{ classroom.banner_image.url }}" alt="{{ classroom.name }}" class="banner-image">
            {% else %}
                <div class="default-banner"></div>
            {% endif %}
            <div class="banner-overlay">
                <div class="classroom-info">
                    <h1 class="classroom-title">{{ classroom.name }}</h1>
                    {% if classroom.section %}
                        <p class="classroom-section">{{ classroom.section }}</p>
                    {% endif %}
                    {% if classroom.subject %}
                        <p class="classroom-subject">{{ classroom.subject }}</p>
                    {% endif %}
                    {% if classroom.description %}
                        <p class="classroom-description">{{ classroom.description }}</p>
                    {% endif %}
                </div>
                <div class="classroom-actions">
                    {% if is_teacher %}
                        <a href="{% url 'classroom:edit' classroom.pk %}" class="btn btn-outline-light">
                            <i class="material-icons">edit</i> Edit Class
                        </a>
                        <a href="{% url 'assignment:create' classroom.slug %}" class="btn btn-outline-light">
                            <i class="material-icons">assignment</i> Create Assignment
                        </a>
                        <a href="{% url 'assignment:list' classroom.slug %}" class="btn btn-outline-light">
                            <i class="material-icons">list</i> View Assignments
                        </a>
                    {% endif %}
                    <div class="classroom-stats">
                        <span class="stat-item">
                            <i class="material-icons">people</i>
                            <span>{{ classroom.student_count }} students</span>
                        </span>
                        <span class="stat-item">
                            <i class="material-icons">person</i>
                            <span>{{ classroom.teacher_count }} teachers</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Classroom Content -->
    <div class="classroom-content">
        <div class="row">
            <!-- Main Content - Announcements -->
            <div class="col-lg-8">
                <div class="announcements-section">
                    <div class="section-header">
                        <h2><i class="material-icons">campaign</i> Announcements</h2>
                        <div class="d-flex gap-2">
                            {% if is_teacher %}
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#announcementModal">
                                    <i class="material-icons">add</i> New Announcement
                                </button>
                            {% endif %}
                            <a href="{% url 'assignment:list' classroom.slug %}" class="btn btn-outline-primary">
                                <i class="material-icons">assignment</i> Assignments
                            </a>
                        </div>
                    </div>

                    {% if announcements %}
                        <div class="announcements-list">
                            {% for announcement in announcements %}
                                <div class="announcement-card {% if announcement.is_pinned %}pinned{% endif %}">
                                    {% if announcement.is_pinned %}
                                        <div class="pinned-indicator">
                                            <i class="material-icons">push_pin</i>
                                        </div>
                                    {% endif %}
                                    <div class="announcement-header">
                                        <h3 class="announcement-title">{{ announcement.title }}</h3>
                                        <div class="announcement-meta">
                                            <span class="author">
                                                {% if announcement.author.profile_pic %}
                                                <img src="{{ announcement.author.profile_pic.url }}" alt="{{ announcement.author.username }}" class="comment-avatar-img">
                                                {% else %}
                                                <i class="material-icons">person</i>
                                                {% endif %}
                                                {{ announcement.author.get_full_name|default:announcement.author.username }}
                                            </span>
                                            <span class="date">
                                                <i class="material-icons">schedule</i>
                                                {{ announcement.created_at|date:"M d, Y g:i A" }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="announcement-content">
                                        {{ announcement.content|linebreaks }}
                                    </div>
                                    
                                    <!-- Comments Section -->
                                    <div class="comments-section">
                                        <div class="comments-header">
                                            <h4><i class="material-icons">comment</i> Comments</h4>
                                        </div>
                                        
                                        <!-- Comments List -->
                                        <div class="comments-list" id="comments-{{ announcement.pk }}">
                                            {% for comment in announcement.comments.all %}
                                                <div class="comment-item">
                                                    <div class="comment-avatar">
                                                        {% if comment.author.profile_pic %}
                                                        <img src="{{ comment.author.profile_pic.url }}" alt="{{ comment.author.username }}" class="comment-avatar-img">
                                                        {% else %}
                                                        <i class="material-icons">account_circle</i>
                                                        {% endif %}
                                                    </div>
                                                    <div class="comment-content">
                                                        <div class="comment-header">
                                                            <span class="comment-author">{{ comment.author.get_full_name|default:comment.author.username }}</span>
                                                            <span class="comment-date">{{ comment.created_at|date:"M d, Y g:i A" }}</span>
                                                        </div>
                                                        <div class="comment-text">{{ comment.content|linebreaks }}</div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <!-- Add Comment Form -->
                                        <form class="comment-form" method="post" action="{% url 'classroom:comment_create' announcement.pk %}">
                                            {% csrf_token %}
                                            <div class="comment-input-group">
                                                <div class="comment-avatar">
                                                    {% if user.profile_pic %}
                                                    <img src="{{ user.profile_pic.url }}" alt="{{ user.username }}" class="comment-avatar-img">
                                                    {% else %}
                                                    <i class="material-icons">account_circle</i>
                                                    {% endif %}
                                                </div>
                                                <div class="comment-input">
                                                    {{ comment_form.content }}
                                                </div>
                                                <button type="submit" class="btn btn-primary btn-sm">
                                                    <i class="material-icons">send</i>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="material-icons">campaign</i>
                            </div>
                            <h3>No announcements yet</h3>
                            <p>{% if is_teacher %}Create the first announcement to get started{% else %}Check back later for updates{% endif %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar - Members and Info -->
            <div class="col-lg-4">
                <div class="classroom-sidebar">
                    <!-- Course Code -->
                    <div class="sidebar-card">
                        <h3><i class="material-icons">vpn_key</i> Course Code</h3>
                        <div class="course-code">
                            <code>{{ classroom.course_code }}</code>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyCourseCode()">
                                <i class="material-icons">content_copy</i>
                            </button>
                        </div>
                    </div>

                    <!-- Admins -->
                    {% if admins %}
                    <div class="sidebar-card">
                        <h3><i class="material-icons">admin_panel_settings</i> Administrators</h3>
                        <div class="members-list">
                            {% for admin in admins %}
                                <div class="member-item">
                                    <div class="member-avatar">
                                        {% if admin.user.profile_pic %}
                                        <img src="{{ admin.user.profile_pic.url }}" alt="{{ admin.user.username }}" class="member-avatar-img">
                                        {% else %}
                                        <i class="material-icons">account_circle</i>
                                        {% endif %}
                                    </div>
                                    <div class="member-info">
                                        <a href="{% url 'accounts:user_detail' admin.user.username %}" class="member-name">{{ admin.user.get_full_name|default:admin.user.username }}</a>
                                        <span class="member-role admin">Admin</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Teachers -->
                    <div class="sidebar-card">
                        <h3><i class="material-icons">person</i> Teachers</h3>
                        <div class="members-list">
                            {% for teacher in teachers %}
                                <div class="member-item">
                                    <div class="member-avatar">
                                        {% if teacher.user.profile_pic %}
                                        <img src="{{ teacher.user.profile_pic.url }}" alt="{{ teacher.user.username }}" class="member-avatar-img">
                                        {% else %}
                                        <i class="material-icons">account_circle</i>
                                        {% endif %}
                                    </div>
                                    <div class="member-info">
                                        <a href="{% url 'accounts:user_detail' teacher.user.username %}" class="member-name">{{ teacher.user.get_full_name|default:teacher.user.username }}</a>
                                        {% if teacher.user == classroom.creator %}
                                            <span class="member-role creator">Creator</span>
                                        {% else %}
                                            <span class="member-role teacher">Teacher</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Students -->
                    <div class="sidebar-card">
                        <h3><i class="material-icons">people</i> Students ({{ classroom.student_count }})</h3>
                        <div class="members-list">
                            {% for student in students %}
                                <div class="member-item">
                                    <div class="member-avatar">
                                        {% if student.user.profile_pic %}
                                        <img src="{{ student.user.profile_pic.url }}" alt="{{ student.user.username }}" class="member-avatar-img">
                                        {% else %}
                                        <i class="material-icons">account_circle</i>
                                        {% endif %}
                                    </div>
                                    <div class="member-info">
                                        <a href="{% url 'accounts:user_detail' student.user.username %}" class="member-name">{{ student.user.get_full_name|default:student.user.username }}</a>
                                        <span class="member-role student">Student</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Classroom Info -->
                    <div class="sidebar-card">
                        <h3><i class="material-icons">info</i> Class Info</h3>
                        <div class="class-info">
                            <div class="info-item">
                                <span class="info-label">Created:</span>
                                <span class="info-value">{{ classroom.created_at|date:"M d, Y" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Last Updated:</span>
                                <span class="info-value">{{ classroom.updated_at|date:"M d, Y" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Announcement Modal -->
{% if is_teacher %}
<div class="modal fade" id="announcementModal" tabindex="-1" aria-labelledby="announcementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="announcementModalLabel">
                    <i class="material-icons">campaign</i> New Announcement
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'classroom:announcement_create' classroom.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="{{ announcement_form.title.id_for_label }}" class="form-label">Title</label>
                        {{ announcement_form.title }}
                    </div>
                    <div class="form-group mb-3">
                        <label for="{{ announcement_form.content.id_for_label }}" class="form-label">Content</label>
                        {{ announcement_form.content }}
                    </div>
                    <div class="form-check">
                        {{ announcement_form.is_pinned }}
                        <label class="form-check-label" for="{{ announcement_form.is_pinned.id_for_label }}">
                            Pin this announcement
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons">send</i> Post Announcement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
    function copyCourseCode() {
        const courseCode = '{{ classroom.course_code }}';
        navigator.clipboard.writeText(courseCode).then(function() {
            // Show success message
            const button = event.target.closest('button');
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="material-icons">check</i>';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-primary');
            
            setTimeout(function() {
                button.innerHTML = originalContent;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
            }, 2000);
        });
    }
</script>

{% with slug=classroom.name|slugify %}
<style>
    .classroom-detail {
        view-transition-name: classroom-whole-{{ slug }};
    }

    .classroom-header {
        margin-bottom: 2rem;
    }

    .classroom-banner {
        position: relative;
        height: 300px;
        overflow: hidden;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        view-transition-name: classroom-banner-{{ slug }};
    }

    .banner-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .default-banner {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #6b8e23, #9acd32);
    }

    .banner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(0,0,0,0.3));
        display: flex;
        align-items: flex-end;
        padding: 2rem;
        color: white;
    }

    .classroom-info {
        flex: 1;
    }

    .classroom-title {
        font-size: 2.5rem;
        font-weight: 500;
        margin: 0 0 0.5rem 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        view-transition-name: classroom-title-{{ slug }};
    }

    .classroom-section {
        font-size: 1.25rem;
        margin: 0 0 0.5rem 0;
        opacity: 0.9;
        view-transition-name: classroom-section-{{ slug }};
    }

    .classroom-subject {
        font-size: 1rem;
        margin: 0 0 1rem 0;
        opacity: 0.8;
        view-transition-name: classroom-subject-{{ slug }};
    }

    .classroom-description {
        font-size: 1rem;
        margin: 0;
        opacity: 0.9;
        max-width: 600px;
    }

    .classroom-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 1rem;
    }

    .classroom-stats {
        display: flex;
        gap: 1.5rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .stat-item i {
        font-size: 1.2rem;
    }

    .announcements-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
    }

    .section-header h2 {
        margin: 0;
        font-size: 1.5rem;
        color: #6b8e23;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .announcements-list {
        padding: 0;
    }

    .announcement-card {
        position: relative;
        padding: 1.5rem;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }

    .announcement-card:hover {
        background-color: #f8f9fa;
    }

    .announcement-card.pinned {
        background-color: #f0f5e8;
        border-left: 4px solid #6b8e23;
    }

    .pinned-indicator {
        position: absolute;
        top: 1rem;
        right: 1rem;
        color: #6b8e23;
    }

    .announcement-header {
        margin-bottom: 1rem;
    }

    .announcement-title {
        font-size: 1.25rem;
        font-weight: 500;
        margin: 0 0 0.5rem 0;
        color: #333;
    }

    .announcement-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: #666;
    }

    .announcement-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .announcement-content {
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }

    .comments-section {
        border-top: 1px solid #eee;
        padding-top: 1rem;
    }

    .comments-header h4 {
        font-size: 1rem;
        margin: 0 0 1rem 0;
        color: #666;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .comments-list {
        margin-bottom: 1rem;
    }

    .comment-item {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .comment-avatar {
        color: #666;
        margin-top: 0.25rem;
    }

    .comment-content {
        flex: 1;
    }

    .comment-header {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
    }

    .comment-author {
        font-weight: 500;
        font-size: 0.875rem;
        color: #333;
    }

    .comment-date {
        font-size: 0.75rem;
        color: #666;
    }

    .comment-text {
        font-size: 0.875rem;
        line-height: 1.4;
        color: #555;
    }

    .comment-form {
        margin-top: 1rem;
    }

    .comment-input-group {
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
    }

    .comment-input {
        flex: 1;
    }

    .comment-input textarea {
        resize: vertical;
        min-height: 40px;
    }

    .classroom-sidebar {
        position: sticky;
        top: 2rem;
    }

    .sidebar-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .sidebar-card h3 {
        font-size: 1.1rem;
        margin: 0 0 1rem 0;
        color: #6b8e23;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .course-code {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .course-code code {
        flex: 1;
        font-family: 'Courier New', monospace;
        font-size: 1rem;
        color: #6b8e23;
        font-weight: 500;
    }

    .members-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .member-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .member-item:last-child {
        border-bottom: none;
    }

    .member-avatar {
        color: #666;
    }

    .member-info {
        flex: 1;
    }

    .member-name {
        display: block;
        font-weight: 500;
        font-size: 0.875rem;
        color: #6b8e23;
        text-decoration: none;
        transition: color 0.3s;
    }
    
    .member-name:hover {
        color: #556b2f;
        text-decoration: underline;
    }

    .member-role {
        font-size: 0.75rem;
        padding: 0.125rem 0.5rem;
        border-radius: 12px;
        font-weight: 500;
    }

    .member-role.creator {
        background: #e8f5e8;
        color: #6b8e23;
    }

    .member-role.teacher {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .member-role.student {
        background: #e8f5e8;
        color: #388e3c;
    }

    .member-role.admin {
        background: #fff3e0;
        color: #f57c00;
    }

    .class-info {
        font-size: 0.875rem;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .info-label {
        color: #666;
        font-weight: 500;
    }

    .info-value {
        color: #333;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        color: #666;
    }

    .empty-state-icon i {
        font-size: 3rem;
        color: #ccc;
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        margin: 0 0 0.5rem 0;
        color: #333;
    }

    .empty-state p {
        margin: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .classroom-title {
            font-size: 2rem;
        }

        .banner-overlay {
            flex-direction: column;
            align-items: flex-start;
            padding: 1rem;
        }

        .classroom-actions {
            align-items: flex-start;
            margin-top: 1rem;
        }

        .classroom-stats {
            flex-direction: column;
            gap: 0.5rem;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .comment-input-group {
            flex-direction: column;
            align-items: stretch;
        }

        .comment-input-group .btn {
            align-self: flex-end;
        }
    }
</style>
{% endwith %}
{% endblock %}
